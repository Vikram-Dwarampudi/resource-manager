<!-- Consistency/Error Message Area -->
<!-- (Removed old consistencyMessage text display) -->
<!-- Pod Creation Message Area -->
<div *ngIf="podMessage"
  [ngClass]="{'pod-message-success': podMessageType === 'success', 'pod-message-error': podMessageType === 'error'}"
  class="pod-message" [innerHTML]="formattedPodMessage"></div>

<!-- Header with title -->
<div class="dashboard-header">
  <div class="header-left">
    <span class="dashboard-title">
      Resource Manager
    </span>
  </div>
</div>



<!-- 1. Resource Information Card (Ribbon) -->
<mat-card class="resource-info-ribbon">
  <div class="resource-info-title">Resource Information</div>
  <div class="ribbon-row">
    <div class="ribbon-stat">
      <div class="ribbon-label">Total Servers</div>
      <div class="ribbon-value">{{ totalServers }}</div>
    </div>
    <div class="ribbon-stat">
      <div class="ribbon-label">Actual RAM Usage</div>
      <div class="ribbon-value">{{ actualRAMUsage }} / {{ totalRAM }} GB</div>
    </div>
    <div class="ribbon-stat">
      <div class="ribbon-label">Actual CPU Usage</div>
      <div class="ribbon-value">{{ actualCPUUsage }} / {{ totalCPUs }}</div>
    </div>
    <div class="ribbon-stat">
      <div class="ribbon-label">Actual GPU Usage</div>
      <div class="ribbon-value">{{ actualGPUUsage }} / {{ totalGPUs }}</div>
    </div>
  </div>
  <div class="ribbon-row">
    <div class="ribbon-stat">
      <div class="ribbon-label">Total Pods</div>
      <div class="ribbon-value">{{ totalPods }}</div>
    </div>
    <div class="ribbon-stat">
      <div class="ribbon-label">Reserved RAM</div>
      <div class="ribbon-value">{{ allocatedRAM }} / {{ totalRAM }} GB</div>
    </div>
    <div class="ribbon-stat">
      <div class="ribbon-label">Reserved CPUs</div>
      <div class="ribbon-value">{{ allocatedCPUs }} / {{ totalCPUs }}</div>
    </div>
    <div class="ribbon-stat">
      <div class="ribbon-label">Reserved GPUs</div>
      <div class="ribbon-value">{{ allocatedGPUs }} / {{ totalGPUs }}</div>
    </div>
  </div>
</mat-card>

<!-- 2. Servers Overview & Selection Card -->
<mat-card class="overview-card">
  <div class="overview-header-row">
    <div>
      <div class="overview-title">Servers Overview</div>
      <div class="overview-desc">
        <mat-icon class="selection-hint-icon">touch_app</mat-icon>
        Select a server to manage its pods. Click on any row to select the server for pod deployment.
      </div>
    </div>
    <button mat-raised-button color="primary" (click)="openServerConfigDialog()">
      Configure Server
    </button>
  </div>
  <div style="max-height: 400px; overflow: auto;">
    <table mat-table [dataSource]="servers" class="mat-elevation-z1">
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Actions </th>
        <td mat-cell *matCellDef="let s">
          <div class="action-buttons">
            <button mat-icon-button color="primary" (click)="reconnectServer(s)" [disabled]="isReconnecting"
              class="medium-icon-button" matTooltip="Reconnect server">
              <mat-icon>refresh</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deconfigureServer(s)" class="medium-icon-button"
              matTooltip="De-configure server">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef> Server Name </th>
        <td mat-cell *matCellDef="let s">{{ s.server_name || s.name }}</td>
      </ng-container>
      <ng-container matColumnDef="ip">
        <th mat-header-cell *matHeaderCellDef> Location </th>
        <td mat-cell *matCellDef="let s">{{ s.metadata?.location || s.ip || 'N/A' }}</td>
      </ng-container>
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Status </th>
        <td mat-cell *matCellDef="let s">
          <span class="status-badge" [ngClass]="getStatusColor(s.status)">
            <mat-icon>{{ getStatusIcon(s.status) }}</mat-icon>
            {{ getStatusDisplayName(s.status) }}
          </span>
        </td>
      </ng-container>
      <ng-container matColumnDef="pods">
        <th mat-header-cell *matHeaderCellDef> Pods </th>
        <td mat-cell *matCellDef="let s">{{ s.pods?.length || 0 }}</td>
      </ng-container>
      <ng-container matColumnDef="ram">
        <th mat-header-cell *matHeaderCellDef> RAM </th>
        <td mat-cell *matCellDef="let s">{{ s.resources?.total?.ram_gb || 0 }} GB</td>
      </ng-container>
      <ng-container matColumnDef="gpus">
        <th mat-header-cell *matHeaderCellDef> GPUs </th>
        <td mat-cell *matCellDef="let s">{{ s.resources?.total?.gpus || 0 }}</td>
      </ng-container>
      <ng-container matColumnDef="cpus">
        <th mat-header-cell *matHeaderCellDef> CPUs </th>
        <td mat-cell *matCellDef="let s">{{ s.resources?.total?.cpus || 0 }}</td>
      </ng-container>
      <ng-container matColumnDef="leds">
        <th mat-header-cell *matHeaderCellDef> Health </th>
        <td mat-cell *matCellDef="let s">
          <div class="server-status-leds">
            <!-- Resource Integrity LED -->
            <div class="led-container resource-integrity-container"
              (mousedown)="checkResourceIntegrity(s, $event)"
              (touchstart)="checkResourceIntegrity(s, $event)"
              [title]="getResourceIntegrityMessage(s) || 'Click to check resource integrity'">
              <div class="led-content">
                <mat-icon class="led-icon">verified</mat-icon>
                <span class="resource-integrity-led" [ngClass]="{
                  'led-green': getResourceIntegrityStatus(s) === 'valid', 
                  'led-red': getResourceIntegrityStatus(s) === 'invalid',
                  'led-grey': getResourceIntegrityStatus(s) === 'unknown'
                }"></span>
              </div>
            </div>

            <!-- Server Connection LED -->
            <div class="led-container server-connection-container"
              (mousedown)="checkServerConnection(s, $event)"
              (touchstart)="checkServerConnection(s, $event)"
              [title]="'Server Connection: ' + (s.status || 'Online') + ' - Click to refresh'">
              <div class="led-content">
                <mat-icon class="led-icon">cloud</mat-icon>
                <span class="server-status-led" [ngClass]="{
                  'led-green': s.status === 'Online', 
                  'led-red': s.status === 'Offline' || s.status === 'ERROR',
                  'led-grey': !s.status
                }"></span>
              </div>
            </div>
          </div>
        </td>
      </ng-container>
      <tr mat-header-row
        *matHeaderRowDef="['actions', 'name', 'ip', 'status', 'pods', 'ram', 'gpus', 'cpus', 'leds']; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: ['actions', 'name', 'ip', 'status', 'pods', 'ram', 'gpus', 'cpus', 'leds'];"
          [ngClass]="{'selected-row': selectedServer && (row.server_id === selectedServer.server_id || row.id === selectedServer.id)}"
          (click)="selectServer(row)">
      </tr>
    </table>
  </div>
</mat-card>

<!-- 4. Pods Overview New Card (Namespace-based) -->
<mat-card class="overview-card">
  <div class="overview-header-row">
    <div>
      <div class="overview-title">
        Pods Overview
        <span class="pod-count-subtitle">({{ allPods.length }} pods) - </span>
        <span class="server-name-subtitle">{{ selectedServer ? (selectedServer.server_name || selectedServer.name) : '' }}</span>
      </div>
      <div class="overview-desc">Namespace-based view with collapsible pods.</div>
    </div>
    <button mat-raised-button color="accent" (click)="openAddPodDialog()">
      Deploy New Pod(s)
    </button>
  </div>
  <div style="max-height: 400px; overflow: auto;">
    <!-- Namespace Cards -->
    <div *ngFor="let namespace of namespaceGroups" class="namespace-card">
      <mat-card class="namespace-header" (click)="toggleNamespace(namespace.name)">
        <div class="namespace-header-content">
          <div class="namespace-info">
            <mat-icon class="expand-icon" [class.expanded]="namespace.expanded">
              {{ namespace.expanded ? 'expand_less' : 'expand_more' }}
            </mat-icon>
                          <div class="namespace-details">
                <div class="namespace-name">{{ namespace.name }}</div>
                <div class="namespace-stats">
                  <span class="pod-count">{{ namespace.pods.length }} pods</span>
                  <span class="status-summary">
                    {{ getNamespaceStatusSummary(namespace) }}
                  </span>
                  <span class="resource-summary">
                    {{ getNamespaceResourceSummary(namespace) }}
                  </span>
                </div>
              </div>
          </div>
          <div class="namespace-actions">
            <button mat-icon-button color="warn" 
                    (click)="deleteNamespace(namespace.name, $event)"
                    matTooltip="Delete entire namespace and all its pods"
                    class="namespace-delete-btn">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </mat-card>
      
      <!-- Expanded Pods List -->
      <div *ngIf="namespace.expanded" class="pods-expanded">
        <table mat-table [dataSource]="namespace.pods" class="pods-table">
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> Actions </th>
            <td mat-cell *matCellDef="let p">
              <div class="action-buttons">
                <button mat-icon-button color="primary" 
                        (click)="openEnvironmentVariableDialog(p)" 
                        class="small-icon-button"
                        matTooltip="Environment Variables">
                  <mat-icon>settings</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>
          
          <ng-container matColumnDef="pod_id">
            <th mat-header-cell *matHeaderCellDef> Pod Name </th>
            <td mat-cell *matCellDef="let p">{{ p.pod_id }}</td>
          </ng-container>
          
          <ng-container matColumnDef="server_name">
            <th mat-header-cell *matHeaderCellDef> Server </th>
            <td mat-cell *matCellDef="let p">{{ p.serverName }}</td>
          </ng-container>
          
          <ng-container matColumnDef="resources">
            <th mat-header-cell *matHeaderCellDef> Resources </th>
            <td mat-cell *matCellDef="let p">
              <div class="resource-details">
                <span class="resource-item">RAM: {{ p.requested?.ram_gb || 0 }}GB</span>
                <span class="resource-item">GPU: {{ p.requested?.gpus || 0 }}</span>
                <span class="resource-item">CPU: {{ p.requested?.cpus || 0 }}</span>
              </div>
            </td>
          </ng-container>
          
          <ng-container matColumnDef="pod_ip">
            <th mat-header-cell *matHeaderCellDef> Pod IP </th>
            <td mat-cell *matCellDef="let p">
              <span *ngIf="p.pod_ip" class="pod-ip">{{ p.pod_ip }}</span>
              <span *ngIf="!p.pod_ip" class="no-ip">Not available</span>
            </td>
          </ng-container>
          
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef> Status </th>
            <td mat-cell *matCellDef="let p">
              <span class="status-badge" [ngClass]="getStatusColor(p.status)">
                <mat-icon>{{ getStatusIcon(p.status) }}</mat-icon>
                {{ getStatusDisplayName(p.status) }}
              </span>
            </td>
          </ng-container>
          
          <tr mat-header-row *matHeaderRowDef="['actions', 'pod_id', 'server_name', 'resources', 'pod_ip', 'status']; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: ['actions', 'pod_id', 'server_name', 'resources', 'pod_ip', 'status'];"></tr>
        </table>
      </div>
    </div>
    
    <!-- No namespaces message -->
    <div *ngIf="namespaceGroups.length === 0" class="no-namespaces">
      <mat-icon>folder_open</mat-icon>
      <p>No namespaces found</p>
    </div>
  </div>
</mat-card>

